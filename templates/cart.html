{% load static %}
<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>Корзина — TIMEPIECE</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="{% static 'style.css' %}" />

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
  </head>

  <body>
    <header class="header glass-panel">
      <div class="container header-inner">
        <a href="/" class="logo">TIMEPIECE</a>

        <!-- Бургер для телефона -->
        <button
          class="nav-toggle"
          type="button"
          aria-label="Открыть меню"
          aria-expanded="false"
        >
          <span class="nav-toggle-line"></span>
          <span class="nav-toggle-line"></span>
          <span class="nav-toggle-line"></span>
        </button>

        <nav class="nav" id="site-nav">
          <a href="/catalog/">Каталог</a>
          <a href="/cart/">Корзина</a>
        </nav>

        <div class="auth-links desktop-only">
          {% if user.is_authenticated %}
          <a href="/account/">Аккаунт</a>
          <a href="{% url 'logout' %}">Выйти</a>
          {% else %}
          <a href="{% url 'login' %}">Войти</a>
          <a href="{% url 'signup' %}">Регистрация</a>
          {% endif %}
        </div>
      </div>
    </header>

    {% if messages %}
    <div class="messages container">
      {% for message in messages %}
      <div class="message {{ message.tags }}">{{ message }}</div>
      {% endfor %}
    </div>
    {% endif %} {% if "Telegram" in request.META.HTTP_USER_AGENT %}
    <div class="container">
      <p class="telegram-mini">
        Если заказ не оформляется в Telegram — откройте сайт в браузере:
        <a href="https://www.timepiece.uz{{ request.get_full_path }}"
          >открыть</a
        >
      </p>
    </div>
    {% endif %}

    <main class="section cart-page">
      <div class="container">
        <div class="glass-panel cart-shell">
          <h1 class="section-title cart-title">Корзина</h1>

          {% if errors.cart %}
          <div class="form-error-global">{{ errors.cart }}</div>
          {% endif %} {% if cart %}
          <div class="cart-block">
            <table class="cart-table">
              <thead>
                <tr>
                  <th>Модель</th>
                  <th>Цена</th>
                  <th>Количество</th>
                  <th>Итого</th>
                  <th></th>
                </tr>
              </thead>

              <tbody>
                {% for item in cart %}
                <tr class="cart-row">
                  <td class="cart-col cart-col--model">
                    <span class="cart-label">Модель</span>
                    <span class="cart-value">{{ item.watch.name }}</span>
                  </td>

                  <td class="cart-col cart-col--price">
                    <span class="cart-label">Цена</span>
                    <span class="cart-value"
                      >{{ item.price }} {{ item.watch.currency }}</span
                    >
                  </td>

                  <td class="cart-col cart-col--qty">
                    <span class="cart-label">Количество</span>

                    <form
                      method="post"
                      action="{% url 'cart_add' item.watch.id %}"
                      class="qty-form"
                    >
                      {% csrf_token %}
                      <div class="qty-control">
                        <button type="button" class="qty-btn" data-dir="-">
                          −
                        </button>

                        <input
                          type="number"
                          name="quantity"
                          value="{{ item.quantity }}"
                          min="1"
                          class="qty-input"
                        />

                        <button type="button" class="qty-btn" data-dir="+">
                          +
                        </button>
                      </div>
                      <input type="hidden" name="update" value="1" />
                    </form>
                  </td>

                  <td class="cart-col cart-col--total">
                    <span class="cart-label">Итого</span>
                    <span class="cart-value"
                      >{{ item.total_price }} {{ item.watch.currency }}</span
                    >
                  </td>

                  <td class="cart-col cart-col--remove">
                    <a href="{% url 'cart_remove' item.watch.id %}" class="link"
                      >Удалить</a
                    >
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>

            <div class="cart-total mono">
              Сумма заказа: {{ cart.get_total_price }} UZS
            </div>
          </div>

          <div class="checkout-block">
            <h2 class="section-title checkout-title">Оформление</h2>

            {% if errors.location or errors.phone or errors.map %}
            <div class="form-error-global">
              Пожалуйста, заполните все поля и выберите точку на карте.
            </div>
            {% endif %}

            <form
              method="post"
              action="{% url 'checkout' %}"
              class="checkout-form"
            >
              {% csrf_token %}

              <div class="form-row">
                <label for="id_location">Локация (адрес текстом):</label>
                <input
                  type="text"
                  name="location"
                  id="id_location"
                  value="{{ form.location|default_if_none:'' }}"
                  required
                  class="checkout-input checkout-input--wide"
                />
                {% if errors.location %}
                <p class="field-error">{{ errors.location }}</p>
                {% endif %}
              </div>

              <div class="form-row">
                <label for="id_phone">Телефон:</label>
                <input
                  type="text"
                  name="phone"
                  id="id_phone"
                  value="{{ form.phone|default_if_none:'' }}"
                  required
                  class="checkout-input checkout-input--narrow"
                />
                {% if errors.phone %}
                <p class="field-error">{{ errors.phone }}</p>
                {% endif %}
              </div>

              <div class="form-row">
                <h3 class="section-title checkout-map-title">
                  Выберите точку на карте
                </h3>
                <p class="mono checkout-map-hint">
                  Кликните по карте, чтобы указать место доставки.
                </p>

                <div id="map" class="checkout-map"></div>

                {% if errors.map %}
                <p class="field-error">{{ errors.map }}</p>
                {% endif %}

                <input
                  type="hidden"
                  name="latitude"
                  id="id_latitude"
                  value="{{ form.latitude|default_if_none:'' }}"
                />
                <input
                  type="hidden"
                  name="longitude"
                  id="id_longitude"
                  value="{{ form.longitude|default_if_none:'' }}"
                />
              </div>

              <div class="checkout-actions">
                <button
                  type="submit"
                  id="checkout-submit"
                  class="btn btn-primary"
                >
                  ПЕРЕЙТИ К ОПЛАТЕ
                </button>
              </div>
            </form>
          </div>

          {% else %}
          <p>Ваша корзина пуста.</p>
          {% endif %}
        </div>
      </div>
    </main>

    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        var map = L.map("map").setView([41.3111, 69.2797], 12);
        var marker = null;

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution: "&copy; OpenStreetMap contributors",
        }).addTo(map);

        var latInput = document.getElementById("id_latitude");
        var lngInput = document.getElementById("id_longitude");
        var locationInput = document.getElementById("id_location");
        var phoneInput = document.getElementById("id_phone");
        var submitBtn = document.getElementById("checkout-submit");

        function setMarker(lat, lng) {
          if (marker) {
            marker.setLatLng([lat, lng]);
          } else {
            marker = L.marker([lat, lng]).addTo(map);
          }
          latInput.value = lat;
          lngInput.value = lng;
          updateSubmitState();
        }

        map.on("click", function (e) {
          var lat = e.latlng.lat.toFixed(6);
          var lng = e.latlng.lng.toFixed(6);
          setMarker(lat, lng);
        });

        function updateSubmitState() {
          var hasLocation = locationInput.value.trim().length > 0;
          var hasPhone = phoneInput.value.trim().length > 0;
          var hasCoords = latInput.value && lngInput.value;

          submitBtn.disabled = !(hasLocation && hasPhone && hasCoords);
        }

        locationInput.addEventListener("input", updateSubmitState);
        phoneInput.addEventListener("input", updateSubmitState);

        if (latInput.value && lngInput.value) {
          setMarker(parseFloat(latInput.value), parseFloat(lngInput.value));
        }

        updateSubmitState();

        document.querySelectorAll(".qty-form").forEach(function (form) {
          var input = form.querySelector(".qty-input");
          var minus = form.querySelector('.qty-btn[data-dir="-"]');
          var plus = form.querySelector('.qty-btn[data-dir="+"]');

          function submitWithValue(val) {
            if (val < 1) val = 1;
            input.value = val;
            form.submit();
          }

          minus.addEventListener("click", function (e) {
            e.preventDefault();
            var current = parseInt(input.value || "1", 10);
            submitWithValue(current - 1);
          });

          plus.addEventListener("click", function (e) {
            e.preventDefault();
            var current = parseInt(input.value || "1", 10);
            submitWithValue(current + 1);
          });
        });
      });
    </script>

    <script>
      (function () {
        const btn = document.querySelector(".nav-toggle");
        const nav = document.getElementById("site-nav");
        if (!btn || !nav) return;

        btn.addEventListener("click", function () {
          const open = nav.classList.toggle("nav-open");
          btn.setAttribute("aria-expanded", open ? "true" : "false");
        });
      })();
    </script>
  </body>
</html>
